---
title: ORM with FastAPI and PostgreSQL
tags:
  - python
  - fastapi
  - postgresql
  - orm
  - sqlalchemy
  - database
---
## FastAPI + PostgreSQL
### DB 연결 준비
#### /project-root/에 db directory 생성
#### PostgreSQL 연결 설정
```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

from dependencies import settings

engine = create_engine(settings.SQLALCHEMY_DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()
Base.metadata.create_all(bind=engine)   # --> 이후 Base는 모든 테이블 클래스가 상속한다.
```

### DB 작업을 하기 위한 테이블 정의
#### 독립적인 Base
##### 기본 Base 생성
```python
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()
```
##### 테이블 정의에 따른 파이썬 클래스 정의
```python
class CorpInfo(Base):
    __tablename__ = "corp_info"

    id = Column(Integer, primary_key=True, autoincrement=True)
    corp_code = Column(String(8))
    corp_name = Column(String)
    corp_name_eng = Column(String)
    stock_name = Column(String)
    stock_code = Column(String(6))
    ceo_nm = Column(String(50))
    corp_cls = Column(String(1))
    jurir_no = Column(String(13))
    bizr_no = Column(String(10))
    adres = Column(String)
    hm_url = Column(String)
    ir_url = Column(String)
    phn_no = Column(String(25))
    fax_no = Column(String(25))
    induty_code = Column(String(10))
    est_dt = Column(String(8))
    acc_mt = Column(String(2))
    logo_img_url = Column(String)  # Assuming this field is not in your CSV
```
#### 프로젝트용 Base
##### 기본 Base 생성
(기본 Base 생성 참조)

##### 테이블 정의에 따른 파이썬 클래스 정의
**ChatHead 테이블:**
```python
from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.orm import relationship
from db.postgres import Base
import datetime


class ChatHead(Base):
    __tablename__ = "chat_head"

    id = Column(Integer, primary_key=True)
    user_id = Column(String)
    service_type = Column(Integer)
    history_id = Column(Integer)
    create_dt = Column(DateTime, default=datetime.datetime.utcnow)
    update_dt = Column(DateTime, default=datetime.datetime.utcnow)

    # chat_history = relationship("ChatHistory", back_populates="chat_head")
```
**ChatHistory 테이블:**
```python
from sqlalchemy import Column, Integer, String, Boolean, DateTime, ForeignKey
from db.postgres import Base
from sqlalchemy.orm import relationship
from sqlalchemy import ForeignKeyConstraint
import datetime


class ChatHistory(Base):
    __tablename__ = "chat_history"

    id = Column(Integer, primary_key=True)
    user_id = Column(String, ForeignKey("chat_head.user_id"))
    service_type = Column(Integer, ForeignKey("chat_head.service_type"))
    history_id = Column(Integer, ForeignKey("chat_head.history_id"))
    role = Column(String)
    content = Column(String)
    regen = Column(Boolean)
    create_dt = Column(DateTime, default=datetime.datetime.utcnow)

    # chat_head = relationship(
    #     "ChatHead",
    #     back_populates="chat_history",
    # )

```
